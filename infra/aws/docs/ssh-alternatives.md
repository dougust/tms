# SSH Alternatives for EC2 Access

You don't actually need SSH keys to access your EC2 instance! Here are better alternatives:

## Option 1: AWS Systems Manager Session Manager (Recommended)

**Pros**:
- ✅ No SSH keys to manage
- ✅ No need to open port 22
- ✅ More secure (uses IAM for authentication)
- ✅ Session logging in CloudWatch
- ✅ Works even in private subnets

**How it works**:
The EC2 instance already has the SSM agent installed and the necessary IAM permissions (we added `AmazonSSMManagedInstanceCore` policy).

### Connect via AWS Console
1. Go to EC2 Console
2. Select your instance
3. Click "Connect" button
4. Choose "Session Manager" tab
5. Click "Connect"

You're in! No SSH key needed.

### Connect via AWS CLI
```bash
# Install Session Manager plugin first (one time)
# macOS
brew install --cask session-manager-plugin

# Then connect
aws ssm start-session --target <INSTANCE_ID>
```

### Update CDK Stack to Remove SSH Key Requirement

You can make the SSH key **optional**:

```typescript
// In lib/dougust-stack.ts
const instance = new ec2.Instance(this, 'DougustInstance', {
  vpc,
  vpcSubnets: {
    subnetType: ec2.SubnetType.PUBLIC,
  },
  role,
  securityGroup,
  instanceType: ec2.InstanceType.of(
    ec2.InstanceClass.T2,
    ec2.InstanceSize.MICRO
  ),
  machineImage: new ec2.AmazonLinuxImage({
    generation: ec2.AmazonLinuxGeneration.AMAZON_LINUX_2023,
    cpuType: ec2.AmazonLinuxCpuType.X86_64,
  }),
  // keyName: keyName,  // COMMENT THIS OUT - no SSH key needed!
  userData,
  blockDevices: [
    // ...
  ],
});
```

Then you can also **close port 22** for better security:

```typescript
// Remove or comment out SSH security group rule
// securityGroup.addIngressRule(
//   ec2.Peer.anyIpv4(),
//   ec2.Port.tcp(22),
//   'Allow SSH access'
// );
```

---

## Option 2: EC2 Instance Connect

**Pros**:
- ✅ No permanent key storage
- ✅ Temporary SSH keys generated by AWS
- ✅ Browser-based access

**Cons**:
- ⚠️ Still requires port 22 open
- ⚠️ Only works in certain regions
- ⚠️ Browser-based console is limited

**How to use**:
1. Go to EC2 Console
2. Select instance
3. Click "Connect"
4. Choose "EC2 Instance Connect"
5. Click "Connect"

---

## Option 3: AWS CloudShell + Session Manager

**Pros**:
- ✅ No local installation needed
- ✅ Everything in the browser
- ✅ No SSH keys

**How to use**:
1. Open AWS CloudShell from AWS Console
2. Run:
```bash
aws ssm start-session --target <INSTANCE_ID>
```

---

## Comparison

| Method | SSH Key | Port 22 Open | IAM Auth | Session Logging | Cost |
|--------|---------|--------------|----------|-----------------|------|
| **SSH with Key** | Required | Yes | No | No | Free |
| **Session Manager** | Not needed | No | Yes | Yes | Free |
| **Instance Connect** | Not needed | Yes | Yes | Limited | Free |
| **CloudShell + SSM** | Not needed | No | Yes | Yes | Free |

---

## Recommended Setup (Most Secure)

### For Production: Use Session Manager Only

**Update `lib/dougust-stack.ts`**:

```typescript
// 1. Remove keyName parameter requirement
export interface DougustStackProps extends StackProps {
  distPath: string;
  keyName?: string;  // Make it optional
  environmentVariables?: Record<string, string>;
}

// 2. Don't open port 22
// Comment out or remove this:
// securityGroup.addIngressRule(
//   ec2.Peer.anyIpv4(),
//   ec2.Port.tcp(22),
//   'Allow SSH access'
// );

// 3. Only add keyName if provided
const instance = new ec2.Instance(this, 'DougustInstance', {
  // ... other props
  ...(keyName && { keyName }), // Only add if keyName is provided
  // ...
});
```

**Update `bin/dougust.ts`**:

```typescript
const keyName = process.env['EC2_KEY_NAME']; // Can be undefined
```

**Benefits**:
- ✅ No SSH keys to manage or lose
- ✅ Port 22 closed (one less attack vector)
- ✅ All access logged in CloudWatch
- ✅ Uses AWS IAM for authentication
- ✅ Supports multi-factor authentication (MFA)

---

## For Development: Keep SSH Key

If you want quick access for development:
- Keep the SSH key requirement
- Use familiar SSH commands
- Can use tools like `scp` for file transfers

---

## Migration Guide: From SSH to Session Manager

**Current setup with SSH**:
```bash
ssh -i ~/.ssh/dougust-key.pem ec2-user@<ELASTIC_IP>
```

**With Session Manager**:
```bash
# Get instance ID from CDK outputs
INSTANCE_ID=$(aws cloudformation describe-stacks \
  --stack-name DougustStack \
  --query 'Stacks[0].Outputs[?OutputKey==`InstanceId`].OutputValue' \
  --output text)

# Connect
aws ssm start-session --target $INSTANCE_ID
```

**Common tasks**:

```bash
# View PM2 logs
aws ssm start-session --target $INSTANCE_ID
pm2 logs dougust-api

# View deployment logs
aws ssm start-session --target $INSTANCE_ID
sudo tail -f /var/log/user-data.log

# Restart application
aws ssm start-session --target $INSTANCE_ID
pm2 restart dougust-api
```

---

## File Transfers with Session Manager

You can still transfer files without SSH:

### Using AWS S3 as intermediary
```bash
# Upload file to S3
aws s3 cp myfile.txt s3://my-bucket/

# On EC2 instance (via Session Manager)
aws s3 cp s3://my-bucket/myfile.txt /home/ec2-user/app/
```

### Using SSM Send-Command
```bash
# Create a file on the instance
aws ssm send-command \
  --document-name "AWS-RunShellScript" \
  --targets "Key=instanceids,Values=$INSTANCE_ID" \
  --parameters 'commands=["echo \"Hello World\" > /home/ec2-user/test.txt"]'
```

---

## Conclusion

**For most users**: Use Session Manager. It's:
- More secure
- Easier to manage (no keys)
- Better for compliance (session logging)
- Already configured in your CDK stack!

**SSH keys are optional** - they're a convenience, not a requirement.
