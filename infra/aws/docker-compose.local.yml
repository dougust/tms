version: '3.8'

services:
  dougust-local:
    image: public.ecr.aws/amazonlinux/amazonlinux:2023
    container_name: dougust-ec2-simulator
    ports:
      - "3000:3000"  # App port
      - "8080:80"    # Nginx port
    volumes:
      # Mount your built application (simulates S3 sync)
      - ../../dist/apps/be:/home/ec2-user/app:ro
      # Mount the actual user data script
      - ./scripts/be-userdata.sh:/userdata-template.sh:ro
    # Run as privileged to allow systemd (needed for nginx/pm2 startup)
    privileged: true
    # Replace placeholders and run the script (simulating what CDK does)
    command: >
      /bin/bash -c "
      sed 's|aws s3 sync s3://{{BUCKET_NAME}}/app/ /home/ec2-user/app/|echo Skipping S3 sync - app mounted via volume|g' /userdata-template.sh |
      sed 's|{{ENV_FILE_CONTENT}}|NODE_ENV=production\nPORT=3000|g' > /userdata.sh &&
      chmod +x /userdata.sh &&
      /userdata.sh &&
      tail -f /var/log/user-data.log
      "
    # Keep container running
    tty: true
    stdin_open: true
